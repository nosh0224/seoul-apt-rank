<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ì„œìš¸ì‹œ ì•„íŒŒíŠ¸ ì‹¤ê±°ë˜ ì¸ì‚¬ì´íŠ¸</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&amp;display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary-bg: #f3f4f6; --accent: #4F46E5; }
        body { background-color: var(--primary-bg); font-family: 'Noto Sans KR', sans-serif; color: #111827; }
        
        /* Navbar */
        .navbar { background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%); padding: 1rem 0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .navbar-brand { font-weight: 800; font-size: 1.4rem; color: white !important; }
        .update-info { color: rgba(255,255,255,0.9); font-size: 0.85rem; margin-right: 15px; }
        .btn-update { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.4); font-size: 0.9rem; transition: .2s; }
        .btn-update:hover { background: rgba(255,255,255,0.3); color: white; transform: translateY(-1px); }

        /* Layout */
        .main-container { max-width: 1400px; margin: 0 auto; padding: 2rem 1rem; }
        .control-bar { background: white; border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .chart-card { background: white; border-radius: 16px; padding: 1.5rem; height: 100%; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .rank-card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); }

        /* Loading Overlay */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 9999;
            display: none; justify-content: center; align-items: center; flex-direction: column;
            color: white; backdrop-filter: blur(5px);
        }
        .spinner-border { width: 3rem; height: 3rem; border-width: 0.25em; }
        
        /* Table & Badges */
        .rank-badge { width: 28px; height: 28px; border-radius: 6px; display: inline-flex; align-items: center; justify-content: center; font-weight: 800; font-size: 0.9rem; }
        .rank-1 { background: #FEF3C7; color: #D97706; }
        .rank-2 { background: #F3F4F6; color: #4B5563; }
        .rank-3 { background: #FFEDD5; color: #C2410C; }
        .rank-other { color: #9CA3AF; }
        .price-tag { font-weight: 700; color: var(--accent); background: #EEF2FF; padding: 4px 10px; border-radius: 12px; font-size: 0.9rem; }
        .apt-link { cursor: pointer; color: #111827; transition: color 0.2s; text-decoration: underline; text-decoration-color: transparent; }
        .apt-link:hover { color: #4F46E5; text-decoration-color: #4F46E5; }
    </style>
  </head>
  <body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="spinner-border text-light mb-3" role="status"></div>
        <h4 class="fw-bold">ë°ì´í„° ìµœì‹ í™” ì§„í–‰ ì¤‘...</h4>
        <p class="text-white-50">API ì„œë²„ ìƒíƒœì— ë”°ë¼ 1~2ë¶„ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤.</p>
        <p class="small text-white-50">í™”ë©´ì„ ë‹«ì§€ ë§ˆì„¸ìš”.</p>
    </div>

    <!-- Detail Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
                <div class="modal-header border-0 pb-0">
                    <div>
                        <h5 class="modal-title fw-bold" id="modalAptName">ì•„íŒŒíŠ¸ëª…</h5>
                        <small class="text-muted" id="modalLoc">ìœ„ì¹˜ ì •ë³´</small>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="modalLoading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">ìƒì„¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                    <div id="modalContent" style="display:none;">
                        <div class="d-flex justify-content-end mb-2">
                            <select id="areaFilter" class="form-select form-select-sm" style="width: auto; min-width: 120px;" onchange="filterAndRenderHistory()">
                                <option value="all">ì „ì²´ ë©´ì </option>
                            </select>
                        </div>
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-hover align-middle text-center small">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>ê³„ì•½ì¼</th>
                                        <th>ê±°ë˜ê¸ˆì•¡</th>
                                        <th>ì „ìš©ë©´ì </th>
                                        <th>ì¸µìˆ˜</th>
                                    </tr>
                                </thead>
                                <tbody id="historyBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="modalError" class="alert alert-warning text-center m-3" style="display:none;"></div>
                </div>
            </div>
        </div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container main-container py-0">
            <span class="navbar-brand">ğŸ™ï¸ ì„œìš¸ì‹œ ì•„íŒŒíŠ¸ ì‹¤ê±°ë˜ ì¸ì‚¬ì´íŠ¸</span>
            <div class="d-flex align-items-center">
                <span class="update-info d-none d-md-block" id="totalCountInfo">ğŸ“Š ì¡°íšŒ: <span id="totalCount">0</span>ê±´</span>
                <span class="update-info d-none d-md-block">ğŸ“… ì—…ë°ì´íŠ¸: {{ last_updated }}</span>
                <button class="btn btn-sm btn-update rounded-pill px-3" onclick="triggerUpdate()">
                    ğŸ”„ ë°ì´í„° ìµœì‹ í™”
                </button>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <!-- Controls -->
        <div class="control-bar">
            <!-- Row 1: Filters & Search -->
            <div class="row g-3 align-items-end mb-2">
                <div class="col-md-2">
                    <label class="form-label fw-bold small text-muted">ë¶„ì„ ë…„ë„</label>
                    <select id="yearSelect" class="form-select" onchange="updateDashboard()">
                        <option value="all">ì „ì²´ (3ë…„ í•©ì‚°)</option>
                        {% for y in years %}
                        <option value="{{ y }}">{{ y }}ë…„</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold small text-muted">ì§€ì—­ (ìì¹˜êµ¬)</label>
                    <select id="districtSelect" class="form-select" onchange="updateDongOptions()">
                        <option value="all">ì„œìš¸ì‹œ ì „ì²´</option>
                        {% for dist in districts %}
                        <option value="{{ dist }}">{{ dist }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold small text-muted">ë™ (ë²•ì •ë™)</label>
                    <select id="dongSelect" class="form-select" onchange="updateDashboard()" disabled>
                        <option value="all">ì „ì²´</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold small text-muted">ì•„íŒŒíŠ¸ëª… ê²€ìƒ‰</label>
                    <input type="text" id="aptSearch" class="form-control" placeholder="ì•„íŒŒíŠ¸ ì´ë¦„ ê²€ìƒ‰..." onkeyup="updateDashboard()">
                </div>
            </div>
            <!-- Row 2: Price & Area Filters -->
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label fw-bold small text-muted">ê°€ê²©ëŒ€</label>
                    <select id="priceSelect" class="form-select" onchange="updateDashboard()">
                        <option value="all">ëª¨ë“  ê°€ê²©ëŒ€</option>
                        <option value="10ì–µ ë¯¸ë§Œ">10ì–µ ë¯¸ë§Œ</option>
                        <option value="10ì–µ~15ì–µ">10ì–µ ~ 15ì–µ</option>
                        <option value="15ì–µ~20ì–µ">15ì–µ ~ 20ì–µ</option>
                        <option value="20ì–µ ì´ìƒ">20ì–µ ì´ìƒ</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold small text-muted">í‰í˜• (ì „ìš©ë©´ì )</label>
                    <select id="areaMainSelect" class="form-select" onchange="updateDashboard()">
                        <option value="all">ì „ì²´</option>
                        <option value="10">10í‰ëŒ€ (40~50ã¡)</option>
                        <option value="20">20í‰ëŒ€ (50~70ã¡)</option>
                        <option value="30">30í‰ëŒ€ (70~102ã¡)</option>
                        <option value="40">40í‰ëŒ€ (102~135ã¡)</option>
                        <option value="50">50í‰ëŒ€ ì´ìƒ (135ã¡~)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row g-4 mb-4">
            <div class="col-lg-5">
                <div class="chart-card">
                    <h6 class="fw-bold mb-3">ğŸ“ ì§€ì—­ë³„ ë¹„ì¤‘</h6>
                    <div style="flex-grow:1; position:relative; min-height:220px;">
                        <canvas id="districtChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-7">
                <div class="chart-card">
                    <h6 class="fw-bold mb-3">ğŸ“ˆ ì—°ë„ë³„ ê±°ë˜ëŸ‰ ì¶”ì´</h6>
                    <div style="flex-grow:1; position:relative; min-height:220px;">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ranking -->
        <div class="rank-card">
            <div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-white">
                <h6 class="m-0 fw-bold">ğŸ† ì¸ê¸° ì•„íŒŒíŠ¸ TOP 20</h6>
                <span class="badge bg-light text-dark border" id="rankBadge">0ê°œ ë‹¨ì§€</span>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0 text-center align-middle">
                    <thead class="table-light">
                        <tr>
                            <th width="7%">ìˆœìœ„</th>
                            <th width="13%">ìœ„ì¹˜</th>
                            <th width="30%" class="text-start ps-3">ì•„íŒŒíŠ¸ëª…</th>
                            <th width="10%">ê±°ë˜ìˆ˜</th>
                            <th width="20%" class="text-end">í‰ê·  ì‹¤ê±°ë˜ê°€</th>
                            <th width="20%" class="text-end pe-3">ìµœê·¼ ê±°ë˜ì¼</th>
                        </tr>
                    </thead>
                    <tbody id="rankBody"></tbody>
                </table>
            </div>
            <div id="noDataMsg" class="text-center p-5 text-muted" style="display:none;">
                <h6>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</h6>
            </div>
        </div>
    </div>

    <script>
        const allData = {{ data_json | safe }};
        const availableYears = {{ years | safe }};
        let districtChart = null;
        let trendChart = null;

        // Pre-process District -> Dong Map
        const districtToDong = {};
        allData.forEach(d => {
            const dist = d['ìì¹˜êµ¬'];
            const dong = d['ë²•ì •ë™'];
            if (!districtToDong[dist]) districtToDong[dist] = new Set();
            districtToDong[dist].add(dong);
        });

        // Convert Sets to sorted Arrays
        for (const dist in districtToDong) {
            districtToDong[dist] = Array.from(districtToDong[dist]).sort();
        }

        function updateDongOptions() {
            const distSelect = document.getElementById('districtSelect');
            const dongSelect = document.getElementById('dongSelect');
            const selectedDist = distSelect.value;

            // Clear existing options
            dongSelect.innerHTML = '<option value="all">ì „ì²´</option>';

            if (selectedDist === 'all') {
                dongSelect.disabled = true;
            } else {
                dongSelect.disabled = false;
                if (districtToDong[selectedDist]) {
                    districtToDong[selectedDist].forEach(dong => {
                        const option = document.createElement('option');
                        option.value = dong;
                        option.text = dong;
                        dongSelect.appendChild(option);
                    });
                }
            }
            updateDashboard();
        }

        // API Update Call
        function triggerUpdate() {
            if (!confirm("ë°ì´í„° ìµœì‹ í™”ë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì•½ 1~2ë¶„ ì†Œìš”ë˜ë©° ê¸°ì¡´ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.)")) return;
            
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            fetch('/update', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert("ì˜¤ë¥˜ ë°œìƒ: " + data.message);
                        document.getElementById('loadingOverlay').style.display = 'none';
                    }
                })
                .catch(err => {
                    alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜: " + err);
                    document.getElementById('loadingOverlay').style.display = 'none';
                });
        }

        function formatKoreanMoney(amount) {
            if (!amount) return "0ì›";
            const uk = Math.floor(amount / 10000); 
            const cheon = Math.round(amount % 10000); 
            let res = "";
            if (uk > 0) res += `<span>${uk}</span>ì–µ `;
            if (cheon > 0) res += `${cheon.toLocaleString()}ë§Œì›`;
            if (uk===0 && cheon===0) return "0ì›";
            return res;
        }

        function getPriceTier(price) {
            if (price < 100000) return "10ì–µ ë¯¸ë§Œ";
            else if (price < 150000) return "10ì–µ~15ì–µ";
            else if (price < 200000) return "15ì–µ~20ì–µ";
            else return "20ì–µ ì´ìƒ";
        }

        function getRankBadge(i) {
            const rank = i + 1;
            if (rank === 1) return `<div class="rank-badge rank-1">1</div>`;
            if (rank === 2) return `<div class="rank-badge rank-2">2</div>`;
            if (rank === 3) return `<div class="rank-badge rank-3">3</div>`;
            return `<div class="rank-badge rank-other">${rank}</div>`;
        }

        function updateDashboard() {
            const yearMode = document.getElementById('yearSelect').value;
            const distMode = document.getElementById('districtSelect').value;
            const dongMode = document.getElementById('dongSelect').value;
            const priceMode = document.getElementById('priceSelect').value;
            const areaMode = document.getElementById('areaMainSelect').value;
            const searchText = document.getElementById('aptSearch').value.toLowerCase();

            let filtered = allData.filter(d => {
                const matchesYear = (yearMode === 'all' || d['ë…„'] == yearMode);
                const matchesDist = (distMode === 'all' || d['ìì¹˜êµ¬'] === distMode);
                const matchesDong = (dongMode === 'all' || d['ë²•ì •ë™'] === dongMode);
                const matchesSearch = (searchText === '' || d['ì•„íŒŒíŠ¸'].toLowerCase().includes(searchText));
                
                let matchesArea = true;
                const areaFloor = Math.floor(d['ì „ìš©ë©´ì ']);
                
                if (areaMode === '10') matchesArea = (areaFloor >= 40 && areaFloor < 50);
                else if (areaMode === '20') matchesArea = (areaFloor >= 50 && areaFloor < 70);
                else if (areaMode === '30') matchesArea = (areaFloor >= 70 && areaFloor < 102);
                else if (areaMode === '40') matchesArea = (areaFloor >= 102 && areaFloor < 135);
                else if (areaMode === '50') matchesArea = (areaFloor >= 135);
                
                return matchesYear && matchesDist && matchesDong && matchesSearch && matchesArea;
            });

            let aggMap = {};
            filtered.forEach(d => {
                const areaFloor = Math.floor(d['ì „ìš©ë©´ì ']);
                const key = d['ìì¹˜êµ¬'] + '|' + d['ë²•ì •ë™'] + '|' + d['ì•„íŒŒíŠ¸'] + (areaMode !== 'all' ? '|' + areaFloor : '');
                if (!aggMap[key]) {
                    aggMap[key] = { 
                        'ìì¹˜êµ¬': d['ìì¹˜êµ¬'], 
                        'ë²•ì •ë™': d['ë²•ì •ë™'], 
                        'ì•„íŒŒíŠ¸': d['ì•„íŒŒíŠ¸'], 
                        'ì´ê¸ˆì•¡': 0, 
                        'ì´ê±´ìˆ˜': 0,
                        'ìµœê·¼ê±°ë˜ì¼': d['ìµœê·¼ê±°ë˜ì¼'],
                        'í‘œì‹œì „ìš©ë©´ì ': areaFloor
                    };
                }
                aggMap[key]['ì´ê±´ìˆ˜'] += d['ê±°ë˜ê±´ìˆ˜'];
                aggMap[key]['ì´ê¸ˆì•¡'] += d['í‰ê· ê±°ë˜ê¸ˆì•¡'] * d['ê±°ë˜ê±´ìˆ˜'];
                if (d['ìµœê·¼ê±°ë˜ì¼'] > aggMap[key]['ìµœê·¼ê±°ë˜ì¼']) {
                    aggMap[key]['ìµœê·¼ê±°ë˜ì¼'] = d['ìµœê·¼ê±°ë˜ì¼'];
                }
            });

            let aggregated = Object.values(aggMap).map(d => {
                d['ê±°ë˜ê±´ìˆ˜'] = d['ì´ê±´ìˆ˜'];
                d['í‰ê· ê±°ë˜ê¸ˆì•¡'] = d['ì´ê±´ìˆ˜'] > 0 ? d['ì´ê¸ˆì•¡'] / d['ì´ê±´ìˆ˜'] : 0;
                d['ê°€ê²©ëŒ€'] = getPriceTier(d['í‰ê· ê±°ë˜ê¸ˆì•¡']);
                return d;
            });

            aggregated = aggregated.filter(d => priceMode === 'all' || d['ê°€ê²©ëŒ€'] === priceMode);
            aggregated.sort((a,b) => b['ê±°ë˜ê±´ìˆ˜'] - a['ê±°ë˜ê±´ìˆ˜'] || b['í‰ê· ê±°ë˜ê¸ˆì•¡'] - a['í‰ê· ê±°ë˜ê¸ˆì•¡']);

            // Table
            const tbody = document.getElementById('rankBody');
            tbody.innerHTML = '';
            document.getElementById('rankBadge').innerText = `${aggregated.length}ê°œ ë‹¨ì§€`;
            
            const totalDealCount = aggregated.reduce((a,c)=>a+c['ê±°ë˜ê±´ìˆ˜'],0);
            if(document.getElementById('totalCount')) {
                document.getElementById('totalCount').innerText = totalDealCount.toLocaleString() + 'ê±´';
            }

            if (aggregated.length === 0) {
                document.getElementById('noDataMsg').style.display = 'block';
            } else {
                document.getElementById('noDataMsg').style.display = 'none';
                aggregated.slice(0, 20).forEach((item, i) => {
                    const areaInfo = areaMode !== 'all' ? `<br><small class="text-primary">${item['í‘œì‹œì „ìš©ë©´ì ']}ã¡</small>` : '';
                    const row = `
                        <tr>
                            <td>${getRankBadge(i)}</td>
                            <td><small class="text-muted">${item['ìì¹˜êµ¬']}</small><br><strong>${item['ë²•ì •ë™']}</strong></td>
                            <td class="text-start ps-3">
                                <strong class="apt-link" onclick="showHistory('${item['ìì¹˜êµ¬']}', '${item['ë²•ì •ë™']}', '${item['ì•„íŒŒíŠ¸']}')">${item['ì•„íŒŒíŠ¸']}</strong>
                                ${areaInfo}
                            </td>
                            <td><span class="badge bg-secondary bg-opacity-10 text-dark">${item['ê±°ë˜ê±´ìˆ˜']}ê±´</span></td>
                            <td class="text-end"><span class="price-tag">${formatKoreanMoney(item['í‰ê· ê±°ë˜ê¸ˆì•¡'])}</span></td>
                            <td class="text-end pe-3"><small class="text-muted">${item['ìµœê·¼ê±°ë˜ì¼']}</small></td>
                        </tr>`;
                    tbody.innerHTML += row;
                });
            }
            
            drawCharts(aggregated, distMode, dongMode);
        }

        function drawCharts(data, distMode, dongMode) {
            // District Chart
            const ctxD = document.getElementById('districtChart').getContext('2d');
            let dStats = {};
            data.forEach(d => {
                // If specific dong is selected, chart by Apartment Name, otherwise by Dong
                // If specific district is selected (but not dong), chart by Dong
                // If no district selected, chart by District
                let k;
                if (distMode === 'all') k = d['ìì¹˜êµ¬'];
                else if (dongMode === 'all') k = d['ë²•ì •ë™'];
                else k = d['ì•„íŒŒíŠ¸']; // Too many items? Handled by slice below
                
                dStats[k] = (dStats[k] || 0) + d['ê±°ë˜ê±´ìˆ˜'];
            });
            const dLabels = Object.keys(dStats).sort((a,b)=>dStats[b]-dStats[a]).slice(0,6);
            
            if(districtChart) districtChart.destroy();
            districtChart = new Chart(ctxD, {
                type: 'doughnut',
                data: {
                    labels: dLabels,
                    datasets: [{ data: dLabels.map(k=>dStats[k]), backgroundColor: ['#4F46E5','#10B981','#F59E0B','#EF4444','#8B5CF6','#6B7280'], borderWidth:0 }]
                },
                options: { responsive:true, maintainAspectRatio:false, cutout:'65%', plugins:{legend:{position:'right', labels:{boxWidth:10}}} }
            });

            // Trend Chart (Yearly)
            // Re-filter from ALL data to show trend regardless of year selection
            const ctxT = document.getElementById('trendChart').getContext('2d');
            let tStats = {};
            availableYears.forEach(y => tStats[y]=0);
            
            const pMode = document.getElementById('priceSelect').value;
            const dSearch = document.getElementById('aptSearch').value.toLowerCase();
            
            allData.forEach(d => {
                if (distMode !== 'all' && d['ìì¹˜êµ¬'] !== distMode) return;
                if (dongMode !== 'all' && d['ë²•ì •ë™'] !== dongMode) return; // Add dong filter to trend chart
                if (pMode !== 'all' && getPriceTier(d['í‰ê· ê±°ë˜ê¸ˆì•¡']) !== pMode) return;
                if (dSearch !== '' && !d['ì•„íŒŒíŠ¸'].toLowerCase().includes(dSearch)) return;

                tStats[d['ë…„']] += d['ê±°ë˜ê±´ìˆ˜'];
            });
            
            if(trendChart) trendChart.destroy();
            trendChart = new Chart(ctxT, {
                type: 'bar',
                data: {
                    labels: Object.keys(tStats),
                    datasets: [{ label:'ê±°ë˜ëŸ‰', data:Object.values(tStats), backgroundColor:'#818cf8', borderRadius:4 }]
                },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{beginAtZero:true}} }
            });
        }

        // Modal Logic
        let detailModal = null;
        let currentHistoryData = []; // Store current modal data for filtering

        document.addEventListener('DOMContentLoaded', () => {
             detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
        });

        function showHistory(gu, dong, apt) {
            document.getElementById('modalAptName').innerText = apt;
            document.getElementById('modalLoc').innerText = `${gu} ${dong}`;
            
            document.getElementById('modalLoading').style.display = 'block';
            document.getElementById('modalContent').style.display = 'none';
            document.getElementById('modalError').style.display = 'none';
            
            // Reset Filter
            document.getElementById('areaFilter').innerHTML = '<option value="all">ì „ì²´ ë©´ì </option>';
            currentHistoryData = [];

            detailModal.show();
            
            fetch(`/api/history?apt_name=${encodeURIComponent(apt)}&dong=${encodeURIComponent(dong)}`)
                .then(res => res.json())
                .then(res => {
                    document.getElementById('modalLoading').style.display = 'none';
                    if(res.status === 'success') {
                        currentHistoryData = res.data; // Store data
                        
                        if (currentHistoryData.length === 0) {
                             document.getElementById('modalError').innerText = "ìƒì„¸ ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.";
                             document.getElementById('modalError').style.display = 'block';
                             return;
                        }

                        // Setup Area Filter Options (using Math.floor)
                        const uniqueAreas = [...new Set(currentHistoryData.map(d => Math.floor(d['ì „ìš©ë©´ì '])))].sort((a,b) => a-b);
                        const areaSelect = document.getElementById('areaFilter');
                        uniqueAreas.forEach(area => {
                            if (area > 0) {
                                const opt = document.createElement('option');
                                opt.value = area;
                                opt.text = `${area}ã¡`;
                                areaSelect.appendChild(opt);
                            }
                        });

                        document.getElementById('modalContent').style.display = 'block';
                        filterAndRenderHistory(); // Initial Render

                    } else {
                        document.getElementById('modalError').innerText = res.message || "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. 'ë°ì´í„° ìµœì‹ í™”'ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.";
                        document.getElementById('modalError').style.display = 'block';
                    }
                })
                .catch(err => {
                    document.getElementById('modalLoading').style.display = 'none';
                    document.getElementById('modalError').innerText = "ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                    document.getElementById('modalError').style.display = 'block';
                });
        }

        function filterAndRenderHistory() {
            const selectedArea = document.getElementById('areaFilter').value;
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '';
            
            let displayData = currentHistoryData;
            
            if (selectedArea !== 'all') {
                displayData = currentHistoryData.filter(d => Math.floor(d['ì „ìš©ë©´ì ']) == selectedArea);
            }
            
            if (displayData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3 text-muted">í•´ë‹¹ ë©´ì ì˜ ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            displayData.forEach(d => {
                const dateStr = d['ê±°ë˜ì¼ì'] || `${d['ë…„']}-${d['ì›”']}-${d['ì¼']}`;
                const area = d['ì „ìš©ë©´ì '] ? `${Math.floor(d['ì „ìš©ë©´ì '])}ã¡` : '-';
                const floor = d['ì¸µ'] ? `${d['ì¸µ']}ì¸µ` : '-';
                const price = formatKoreanMoney(d['ê±°ë˜ê¸ˆì•¡']);
                
                tbody.innerHTML += `
                    <tr>
                        <td>${dateStr}</td>
                        <td class="fw-bold text-primary">${price}</td>
                        <td>${area}</td>
                        <td>${floor}</td>
                    </tr>
                `;
            });
        }

        updateDashboard();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
